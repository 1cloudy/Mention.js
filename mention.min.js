(function(f){f.fn.extend({mention:function(j){this.opts={users:[],delimiter:"@",sensitive:!0,queryBy:["name","username"],typeaheadOpts:{}};var g=f.extend({},this.opts,j),k=function(e){for(var c in g.queryBy)if(e[g.queryBy[c]]){var b=e[g.queryBy[c]].toLowerCase(),a=this.query.toLowerCase().match(RegExp(g.delimiter+"\\w+","g")),d;if(a)for(d=0;d<a.length;d++){var f=a[d].substring(1).toLowerCase(),h=RegExp(g.delimiter+b,"g"),h=this.query.toLowerCase().match(h);if(-1!=b.indexOf(f)&&null===h)return!0}}},l=function(e){var c=this.query,b=this.$element[0].selectionStart,a;for(a=b;0<=a&&c[a]!=g.delimiter;a--);b=c.substring(a,b);return this.tempQuery=c=c.replace(b,g.delimiter+e)},m=function(e){if(e.length&&g.sensitive){var c=this.query,b=this.$element[0].selectionStart,a;for(a=b;0<=a&&c[a]!=g.delimiter;a--);c=c.substring(a,b).substring(1);a=e.length;var d={highest:[],high:[],med:[],low:[]},f=[];if(1==c.length){for(b=0;b<a;b++){var h=e[b];h.username[0]==c?d.highest.push(h):h.username[0].toLowerCase()==c.toLowerCase()?d.high.push(h):-1!=h.username.indexOf(c)?d.med.push(h):d.low.push(h)}for(b in d)for(var j in d[b])f.push(d[b][j]);return f}}return e};f.fn.typeahead.Constructor.prototype.render=function(e){var c=this;e=f(e).map(function(b,a){b=f(c.options.item).attr("data-value",a.username);var d=f("<div />");a.image&&d.append('<img class="mention_image" src="'+a.image+'">');a.name&&d.append('<b class="mention_name">'+a.name+"</b>");a.username&&d.append('<span class="mention_username"> '+g.delimiter+a.username+"</span>");b.find("a").html(c.highlighter(d.html()));return b[0]});e.first().addClass("active");this.$menu.html(e);return this};return this.each(function(){var e=f(this);if("undefined"==typeof f)throw Error("jQuery is Required");if("undefined"==typeof f.fn.typeahead)throw Error("Typeahead is Required");e.typeahead(f.extend({source:g.users,matcher:k,updater:l,sorter:m},g.typeaheadOpts))})}})})(jQuery);
